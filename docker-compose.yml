services:
  app:
    build:
      context: .
      target: dev
    ports:
      - "3000:3000"
    volumes:
      - .:/app
      - /app/node_modules
      - bun_cache:/root/.bun
    environment:
      - NODE_ENV=development
    command: ["bun", "dev"]

  app-prod:
    profiles:
      - prod
    build:
      context: .
      target: prod
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
    command: ["bun", "start"]

  firecrawl-api:
    image: ghcr.io/firecrawl/firecrawl:latest
    env_file:
      - .env.firecrawl
    environment:
      HOST: 0.0.0.0
      PORT: 3002
      INTERNAL_PORT: 3002
      EXTRACT_WORKER_PORT: 3004
      WORKER_PORT: 3005
      ENV: local
      NUQ_RABBITMQ_URL: amqp://rabbitmq:5672
      REDIS_URL: redis://redis:6379
      REDIS_RATE_LIMIT_URL: redis://redis:6379
      PLAYWRIGHT_MICROSERVICE_URL: http://playwright-service:3000/scrape
      POSTGRES_HOST: nuq-postgres
      POSTGRES_PORT: 5432
    depends_on:
      redis:
        condition: service_started
      playwright-service:
        condition: service_started
      rabbitmq:
        condition: service_healthy
      nuq-postgres:
        condition: service_started
    ports:
      - "3002:3002"
    networks:
      - firecrawl

  playwright-service:
    image: ghcr.io/firecrawl/playwright-service:latest
    env_file:
      - .env.firecrawl
    environment:
      PORT: 3000
      MAX_CONCURRENT_PAGES: ${CRAWL_CONCURRENT_REQUESTS:-10}
    networks:
      - firecrawl

  redis:
    image: redis:alpine
    command: redis-server --bind 0.0.0.0
    networks:
      - firecrawl

  rabbitmq:
    image: rabbitmq:3-management
    command: rabbitmq-server
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "check_running"]
      interval: 5s
      timeout: 5s
      retries: 3
      start_period: 5s
    networks:
      - firecrawl

  nuq-postgres:
    image: ghcr.io/firecrawl/nuq-postgres:latest
    env_file:
      - .env.firecrawl
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-postgres}
    networks:
      - firecrawl

volumes:
  bun_cache:

networks:
  firecrawl:
    driver: bridge
